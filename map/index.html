<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Find Flash payment locations worldwide - Interactive map of businesses accepting Bitcoin Lightning payments through Flash." />

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="../../assets/img/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/img/favicon-16x16.png" sizes="16x16" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/pages/map.css" />

    <!-- Google Maps API -->
    <script>
        function initMap() {
            // This will be defined in our main script below
            window.initMapCallback();
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrZtvg_PSLuDUcMQ9BapDyTlc821oLM2w&libraries=places&callback=initMap&loading=async"></script>

    <title>Flash Map - Find Payment Locations Worldwide | Flash</title>
    <script src="../../js/core/dark-mode-init.js"></script>
</head>

<body>
    <div id="header-placeholder"></div>

    <!-- Map Container with Overlay Search -->
    <!-- Map Container with Overlay Search -->
    <section class="container" style="padding-top: 0; margin-top: 0;">
        <div class="map-container">
            <!-- Search Overlay -->
            <div class="search-overlay">
                <input type="text" class="search-input" id="searchInput" placeholder="Search locations...">
                <button class="filter-btn" id="filterBtn">Filter</button>
                <div class="location-count">
                    <span id="locationCount">0 locations</span>
                </div>
            </div>

            <!-- Coming Soon Overlay -->
            <div class="coming-soon-overlay" style="display: none;">
                <div class="coming-soon-content">
                    <div class="coming-soon-icon">üöÄ</div>
                    <h2 class="coming-soon-title">Coming Soon</h2>
                    <p class="coming-soon-subtitle">
                        We're building an amazing interactive map to help you discover Flash payment locations
                        worldwide.
                        Stay tuned for this exciting feature!
                    </p>
                    <p class="coming-soon-note">
                        This page will be updated soon with live location data and search functionality.
                    </p>
                    <a href="/" class="back-button">
                        <span>‚Üê</span>
                        Back to Home
                    </a>
                </div>
            </div>

            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div id="map"></div>

            <!-- Side Panel for Location Details -->
            <div id="sidePanel" class="side-panel">
                <div class="side-panel-header">
                    <button class="close-panel" id="closePanelBtn">&times;</button>
                    <h3 id="panelTitle">Location Details</h3>
                </div>
                <div class="side-panel-content" id="panelContent">
                    <!-- Location details will be populated here -->
                </div>
            </div>

            <!-- Footer -->
            <!-- Footer -->
            <div id="footer-placeholder"></div>

            <div id="svg-icons-placeholder"></div>

            <!-- Load components BEFORE other scripts -->
            <script src="../../js/core/component-loader.js"></script>

            <!-- Scripts -->
            <!-- jQuery (for main.js compatibility) -->
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

            <script>
                // Global variables
                let map;
                let markers = [];
                let flashpoints = [];
                let infoWindow;

                // Initialize the map
                window.initMapCallback = function () {
                    // Show loading spinner
                    document.getElementById('loadingSpinner').style.display = 'flex';

                    // Create the map
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: { lat: 0, lng: 0 },
                        zoom: 2,
                        styles: getMapStyles(),
                        mapTypeControl: true,
                        streetViewControl: true,
                        fullscreenControl: true,
                        zoomControl: true
                    });

                    // Create info window
                    infoWindow = new google.maps.InfoWindow();

                    // Load flashpoints from API
                    loadFlashpoints().then(() => {
                        document.getElementById('loadingSpinner').style.display = 'none';
                    }).catch((error) => {
                        console.error('Error loading map:', error);
                        document.getElementById('loadingSpinner').style.display = 'none';
                    });

                    // Setup search functionality
                    setupSearch();
                };

                // Load flashpoints from GraphQL API
                async function loadFlashpoints() {
                    try {
                        // Determine API URL based on deployment environment
                        const apiUrl = window.location.hostname === 'getflash.io' || window.location.hostname === 'www.getflash.io'
                            ? 'https://api.flashapp.me/graphql'
                            : 'https://api.test.flashapp.me/graphql';
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                query: `
              query BusinessMapMarkers {
                businessMapMarkers {
                  mapInfo {
                    coordinates {
                      latitude
                      longitude
                    }
                    title
                  }
                  username
                }
              }
            `
                            })
                        });

                        const data = await response.json();
                        flashpoints = data.data.businessMapMarkers;

                        // Update location count
                        document.getElementById('locationCount').textContent = `${flashpoints.length} locations found`;

                        // Add markers to map
                        addMarkersToMap();

                        // Fit map to show all markers
                        fitMapToMarkers();

                    } catch (error) {
                        console.error('Error loading flashpoints:', error);
                        document.getElementById('locationCount').textContent = 'Error loading locations';
                    }
                }

                // Add markers to the map
                function addMarkersToMap() {
                    // Clear existing markers
                    clearMarkers();

                    flashpoints.forEach((flashpoint, index) => {
                        const position = {
                            lat: parseFloat(flashpoint.mapInfo.coordinates.latitude),
                            lng: parseFloat(flashpoint.mapInfo.coordinates.longitude)
                        };

                        // Create custom marker
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: flashpoint.mapInfo.title,
                            icon: createCustomMarkerIcon(),
                            animation: google.maps.Animation.DROP
                        });

                        // Add click listener
                        marker.addListener('click', () => {
                            showLocationDetails(flashpoint, marker);
                        });

                        markers.push(marker);
                    });
                }

                // Create custom marker icon
                function createCustomMarkerIcon() {
                    return {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
            <circle cx="15" cy="15" r="12" fill="url(#gradient)" stroke="white" stroke-width="3"/>
            <text x="15" y="19" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="12" font-weight="bold">‚Çø</text>
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#f39c12"/>
                <stop offset="100%" style="stop-color:#e74c3c"/>
              </linearGradient>
            </defs>
          </svg>
        `),
                        scaledSize: new google.maps.Size(30, 30),
                        anchor: new google.maps.Point(15, 15)
                    };
                }

                // Show location details
                function showLocationDetails(flashpoint, marker) {
                    const content = `
        <div class="info-window">
          <div class="info-title">${flashpoint.mapInfo.title}</div>
          <div class="info-username">@${flashpoint.username}</div>
          <div class="info-services">
            <span class="service-badge">Flash Payment</span>
            <span class="service-badge">Bitcoin</span>
            <span class="service-badge">Lightning</span>
          </div>
        </div>
      `;

                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);

                    // Also populate side panel
                    populateSidePanel(flashpoint);
                }

                // Populate side panel with detailed information
                function populateSidePanel(flashpoint) {
                    const panelContent = document.getElementById('panelContent');
                    const panelTitle = document.getElementById('panelTitle');

                    panelTitle.textContent = flashpoint.mapInfo.title;

                    panelContent.innerHTML = `
        <div class="location-details">
          <h4>Business Information</h4>
          <p><strong>Username:</strong> @${flashpoint.username}</p>
          <p><strong>Location:</strong> ${flashpoint.mapInfo.title}</p>
          
          <h4>Available Services</h4>
          <div class="info-services">
            <span class="service-badge">Flash Payments</span>
            <span class="service-badge">Bitcoin Lightning</span>
            <span class="service-badge">Mobile App</span>
          </div>
          
          <h4>Coordinates</h4>
          <p><strong>Latitude:</strong> ${flashpoint.mapInfo.coordinates.latitude}</p>
          <p><strong>Longitude:</strong> ${flashpoint.mapInfo.coordinates.longitude}</p>
          
          <div style="margin-top: 20px;">
            <button class="filter-btn" onclick="centerMapOnLocation(${flashpoint.mapInfo.coordinates.latitude}, ${flashpoint.mapInfo.coordinates.longitude})">
              Center Map
            </button>
          </div>
        </div>
      `;

                    // Open side panel
                    document.getElementById('sidePanel').classList.add('open');
                }

                // Center map on specific location
                function centerMapOnLocation(lat, lng) {
                    map.setCenter({ lat: parseFloat(lat), lng: parseFloat(lng) });
                    map.setZoom(15);
                }

                // Fit map to show all markers
                function fitMapToMarkers() {
                    if (markers.length === 0) return;

                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });

                    map.fitBounds(bounds);

                    // Ensure minimum zoom level
                    google.maps.event.addListenerOnce(map, 'bounds_changed', function () {
                        if (map.getZoom() > 15) {
                            map.setZoom(15);
                        }
                    });
                }

                // Clear all markers
                function clearMarkers() {
                    markers.forEach(marker => {
                        marker.setMap(null);
                    });
                    markers = [];
                }

                // Setup search functionality
                function setupSearch() {
                    const searchInput = document.getElementById('searchInput');

                    searchInput.addEventListener('input', createDebounce(performSearch, 300));

                    // Setup Places Autocomplete
                    const autocomplete = new google.maps.places.Autocomplete(searchInput);
                    autocomplete.setFields(['geometry', 'name']);

                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        if (place.geometry) {
                            map.setCenter(place.geometry.location);
                            map.setZoom(12);
                        }
                    });
                }

                // Perform search
                function performSearch() {
                    const query = document.getElementById('searchInput').value.toLowerCase();

                    if (!query) {
                        addMarkersToMap();
                        return;
                    }

                    const filteredFlashpoints = flashpoints.filter(flashpoint =>
                        flashpoint.mapInfo.title.toLowerCase().includes(query) ||
                        flashpoint.username.toLowerCase().includes(query)
                    );

                    // Clear current markers
                    clearMarkers();

                    // Add filtered markers
                    filteredFlashpoints.forEach((flashpoint, index) => {
                        const position = {
                            lat: parseFloat(flashpoint.mapInfo.coordinates.latitude),
                            lng: parseFloat(flashpoint.mapInfo.coordinates.longitude)
                        };

                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: flashpoint.mapInfo.title,
                            icon: createCustomMarkerIcon()
                        });

                        marker.addListener('click', () => {
                            showLocationDetails(flashpoint, marker);
                        });

                        markers.push(marker);
                    });

                    // Update count
                    document.getElementById('locationCount').textContent = `${filteredFlashpoints.length} locations found`;

                    // Fit map to filtered results
                    if (markers.length > 0) {
                        fitMapToMarkers();
                    }
                }

                // Debounce function (check if already exists in main.js)
                function createDebounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Map styles (supports dark mode)
                function getMapStyles() {
                    const isDarkMode = document.body.classList.contains('dark-mode');

                    if (isDarkMode) {
                        return [
                            { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
                            { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
                            { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                            {
                                featureType: 'administrative.locality',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'poi',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'poi.park',
                                elementType: 'geometry',
                                stylers: [{ color: '#263c3f' }]
                            },
                            {
                                featureType: 'poi.park',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#6b9a76' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'geometry',
                                stylers: [{ color: '#38414e' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'geometry.stroke',
                                stylers: [{ color: '#212a37' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#9ca5b3' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'geometry',
                                stylers: [{ color: '#746855' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'geometry.stroke',
                                stylers: [{ color: '#1f2835' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#f3d19c' }]
                            },
                            {
                                featureType: 'transit',
                                elementType: 'geometry',
                                stylers: [{ color: '#2f3948' }]
                            },
                            {
                                featureType: 'transit.station',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'geometry',
                                stylers: [{ color: '#17263c' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#515c6d' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'labels.text.stroke',
                                stylers: [{ color: '#17263c' }]
                            }
                        ];
                    }

                    return []; // Default Google Maps styling for light mode
                }

                // Close side panel
                document.getElementById('closePanelBtn').addEventListener('click', () => {
                    document.getElementById('sidePanel').classList.remove('open');
                });

                // Filter button functionality
                document.getElementById('filterBtn').addEventListener('click', () => {
                    // Add filter functionality here
                    alert('Filter functionality coming soon!');
                });

                // Update map styles when theme changes
                function updateMapStyles() {
                    if (map) {
                        map.setOptions({ styles: getMapStyles() });
                    }
                }

                // Listen for theme changes
                document.addEventListener('DOMContentLoaded', function () {
                    const themeToggle = document.getElementById('theme-toggle');
                    if (themeToggle) {
                        themeToggle.addEventListener('click', () => {
                            setTimeout(updateMapStyles, 100); // Wait for theme to change
                        });
                    }
                });

                // Error handling for map loading
                window.gm_authFailure = function () {
                    document.getElementById('map').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e74c3c; text-align: center;">
          <div>
            <h3>Map Loading Error</h3>
            <p>Please check your Google Maps API key configuration.</p>
          </div>
        </div>
      `;
                };
            </script>

            <!-- Load main.js after our custom scripts -->
            <script src="../../js/core/main.js"></script>

            <!-- Bitcoin Price Tracker -->
            <script src="../../js/modules/btcTracker.js"></script>

            <!-- Tidio Chat Widget -->
            <script src="//code.tidio.co/widget-v4/wubhfrzwetbvbkgfozwhqxp9w1j3y3rp.js" async></script>
</body>

</html>